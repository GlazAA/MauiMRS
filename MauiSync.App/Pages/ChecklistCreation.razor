@page "/checklist-creation"
@using MauiSync.Core.Models
@inject IDataService DataService
@inject NavigationManager NavigationManager
@using MauiSync.Core.Services
<!-- 2, где фильтры  -->


<h3>Создание контрольных листов</h3>

<div class="filters-container">
    <div class="filter-group">
        <label>Клиент:</label>
        <select @bind="selectedClientId" @onchange="OnClientChanged" class="form-control">
            <option value="0">Выберите клиента...</option>
            @foreach (var org in organizations)
            {
                <option value="@org.Id">@org.FullName</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <label>Объект:</label>
        <select @bind="selectedFacilityId" @onchange="OnFacilityChanged" class="form-control">
            <option value="0">Выберите объект...</option>
            @foreach (var facility in facilities)
            {
                <option value="@facility.Id">@facility.Name</option>
            }
        </select>
    </div>
    
    <div class="filter-group">
        <label>Система:</label>
        <select @bind="selectedSystemId" class="form-control">
            <option value="0">Выберите систему...</option>
            @foreach (var system in systems)
            {
                <option value="@system.Id">@system.Name</option>
            }
        </select>
    </div>
    
    <button @onclick="NavigateToEquipmentTypes" class="btn btn-primary" 
            disabled="!CanProceed">
        Типы оборудований →
    </button>
</div>

@code {
    private int selectedClientId = 0;
    private int selectedFacilityId = 0;
    private int selectedSystemId = 0;
    
    private List<Organization> organizations = new();
    private List<Facility> facilities = new();
    private List<FacilitySystem> systems = new(); // ИЗМЕНИЛ System на FacilitySystem
    
    private bool CanProceed => selectedClientId > 0 && selectedFacilityId > 0 && selectedSystemId > 0;
    
    protected override async Task OnInitializedAsync()
    {
        organizations = await DataService.GetOrganizationsAsync();
    }
    
    private async Task OnClientChanged()
    {
        facilities.Clear();
        systems.Clear();
        selectedFacilityId = 0;
        selectedSystemId = 0;
        
        if (selectedClientId > 0)
        {
            facilities = await DataService.GetFacilitiesAsync(selectedClientId);
        }
        StateHasChanged();
    }
    
    private async Task OnFacilityChanged()
    {
        systems.Clear();
        selectedSystemId = 0;
        
        if (selectedFacilityId > 0)
        {
            systems = await DataService.GetSystemsAsync(selectedFacilityId);
        }
        StateHasChanged();
    }
    
    private void NavigateToEquipmentTypes()
    {
        NavigationManager.NavigateTo($"/equipment-types/{selectedSystemId}");
    }
}